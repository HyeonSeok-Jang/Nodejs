const http = require('http');
const fs = require('fs).promises;
//서버에서 요구하는... 패키지?

const users = {}; // 데이터 저장용

http
  .createServer(async (req, res)=>{
  	//서버 생성 콜백함수로 구현
  	try{
  		if(req.method === 'GET'){
  			// restFront.js에서 받는
  			// 그러니까 클라이언트에서 받는 메소드가
  			// GET방식일 경우...
  			if(req.url === '/'){
  				const data = await fs.readFile('./restFront.html');
  				// data에 받는 promise가
  				// fs.readFile메소드를 이용해 매개변수 경로의 file을 read한다
  				res.writeHead(200, { 'Content-Type': 'text/html, charset=utf-8' });
  				// 응답에 위부터 이렇게 적는다.
  				return res.end(data);
  				// 응답 종료 + 메소드를 종료하기 위해 return
  			}else if ( req.url === '/about'){
  				const data = await fs.readFile('./restFront.html');  				
  				res.writeHead(200, { 'Content-Type': 'text/html, charset=utf-8' });  				
  				return res.end(data);
  			}else if ( req.url === '/users'){
  				res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
  				return res.end(JSON.stringift(users));
  				//브라우저에 user객체를 전송, 문자열로 변환하여 전송
  			}
  			// /도 /about도 /users도 아니면
  			try{
  				const data = await fs.readFile(`.${req.url}`);
  				// file read를 하는데, 요청받은 url로 발견
  				return res.end(data);
  			}catch(err){
  				// 주소에 해당하는 라우트를 못찾았다는 404NotFound 발생
  			}
  		}else if (req.method ==='POST'){
  			if(req.url ==='/user'){
  				// 메소드가 post에 user라면...
  				let body = '';
  				//요청의 body를 stream 형식으로 받아서
  				req.on('data',(data)=>{
  					//req의 on?으로 받는다. data를...
  					body += data;
  				});
  				//요청의 body를 다 받은 후 실행
  				return req.on('end',()=>{
  					console.log('POST 본문(Body):', body);
  					const {name} = JSON.parse(body);
  					const id= Date.now();
  					users[id] = name;
  					res.writeHead(201);
  					res.end('ok');
  				});
  			}
  		}else if(req.method === 'PUT'){
  			if(req.url.statusWith('/user/')){
  				//만약 요청 url이 /user/를 포함한다면~
  				const key = req.url.split('/')[2];
  				// /로 쪼개서
  				let body = '';
  				req.on('data', (data) =>{
  					body += data;	
  				});
  				return req.on('end',()=>{
  					console.log('PUT 본문(Body):',body);
  					users[key] = JSON.parse(body).name;
  					res.writeHead(200);
  					return res.end('ok');
  				});
  			}
  		}
  		res.writeHead(404);
  			return res.end('NOT FOUND');
  	}catch(err){
  		console.error(err);
  	}
  }